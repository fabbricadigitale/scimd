// This file was automatically generated by genny.
// Any changes will be lost if this file is regenerated.
// see https://github.com/cheekybits/genny

package schemas

import (
	"encoding/json"
	"errors"
	"io/ioutil"
	"sync"

	"github.com/fabbricadigitale/scimd/schemas/core"
)

type repositorySchema struct {
	items map[string]core.Schema
	mu    sync.RWMutex
}

// SchemaRepository is the ...
type SchemaRepository interface {
	Get(key string) *core.Schema
	Add(filename string) (core.Schema, error)
}

func (repo *repositorySchema) Get(key string) *core.Schema {
	repo.mu.RLock()
	defer repo.mu.RUnlock()
	if item, ok := repo.items[key]; ok {
		return &item
	}
	return nil
}

func (repo *repositorySchema) Add(filename string) (core.Schema, error) {
	var data core.Schema

	bytes, err := ioutil.ReadFile(filename)
	if err != nil {
		return data, err
	}
	err = json.Unmarshal(bytes, &data)
	if err != nil {
		return data, err
	}

	repo.mu.Lock()
	defer repo.mu.Unlock()

	var id string
	if id = interface{}(data).(Identifiable).GetIdentifier(); id == "" {
		return data, errors.New("missing identifier")
	}

	repo.items[id] = data

	return data, nil
}

var (
	repoSchema *repositorySchema
	onceSchema sync.Once
)

// GetSchemaRepository is a singleton repository for core schemas
func GetSchemaRepository() SchemaRepository {
	onceSchema.Do(func() {
		repoSchema = &repositorySchema{
			items: make(map[string]core.Schema),
		}
	})

	return repoSchema
}
